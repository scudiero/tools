%spidercode%
var pathbase = tcfdata.pagename[0].replace(/^\/([^\/]*)\/.*/, "/$1");
print_doc("HERE 1 HERE 1 HERE\n")
tcfdata.pathbase = attr_write("pathbase", pathbase, {savetcf:false});
%spidercode%
%import %progdir%/%template%/util.atj:atj
%import %progdir%/%template%/vote.atj:atj
%import %pathbase%/custom.atj:atj
///
%spidercode%

	var nextsignoff = tcfdata.views.tso.mustsignoff[0];
	var lastapproval = tcfdata.views && tcfdata.views.tso && tcfdata.views.tso.tsodate && tcfdata.views.tso.tsodate.length ?
			tcfdata.views.tso.tsodate[0] : tcfdata.lastmodtime[0];
	if(tcfdata.views && tcfdata.views.tso && tcfdata.views.tso.tsoaction && tcfdata.views.tso.tsoaction.length)
		lastapproval = tcfdata.views.tso.tsoaction[tcfdata.views.tso.tsoaction.length-1].when;
	lastapproval = new Date(lastapproval);

	print_doc("HERE 2 HERE 2 HERE\n")
	// Timed Vote
	if(cimvote) {
		print_doc("HERE 3 HERE 3 HERE\n")
		var voterule = cimvote.setVoteRule(nextsignoff);
		// print_doc("voterule = '" + voterule + "'\n");
		// print_doc("voterule.duration = '" + voterule.duration + "'\n");
		// print_doc("isNaN(parseInt(voterule.duration, 10)) = '" + isNaN(parseInt(voterule.duration, 10)) + "'\n");
		// print_doc("parseInt(voterule.duration, 10) = '" + parseInt(voterule.duration, 10) + "'\n");

		if(voterule && voterule.duration && !isNaN(parseInt(voterule.duration, 10)) && parseInt(voterule.duration, 10) > 0 &&
				!isNaN(lastapproval.getTime())) {
			print_doc("HERE 4 HERE 4 HERE\n")
			//check vote duration compared to last approved date and see if time is up
			var now = new Date().getTime();
			var days = (now - lastapproval.getTime()) / 1000 / 60 / 60 / 24;
			print_doc("now = '" + now + "'\n"); print_doc("days = '" + days + "'\n"); print_doc("cimvote.isVotePassed() = '" + cimvote.isVotePassed() + "'\n"); 
			print_doc("parseInt(voterule.duration, 10) = '" + parseInt(voterule.duration, 10) + "'\n");
			
			if(days > parseInt(voterule.duration, 10) && cimvote.isVotePassed()) {
				print_debug("VOTE PASSED: " + tcfdata.pagename[0] + " -- " + nextsignoff + " (cim/cimsync.html)\n");
				var voteapproved = true;
				cimvote.approveVote();
			}
		}
	}


	// esigs
	if(esig && esig.isWFStep({wfstep: nextsignoff}) && esig.needsSig({wfstep: nextsignoff}).length === 0) {
		var syncapprove = true;
		// Approved:path|revid|role|[rejectto|comment]
		var args = 'Approved:' + tcfdata.pagename[0] + '|' + revid + '|' + nextsignoff;
		addapprovelist(args);
	}

%spidercode%
%approvepages%

